ì „ì—ëŠ” yaml íŒŒì¼ë¡œ í–ˆì—ˆìŒ


graphql API íƒ€ì… ë‹¤ìš´ë°›ê¸°
  1. graphql codegen ì ‘ì†
  2. yarn add --dev @graphql-codegen/cli ì„¤ì¹˜(graphql, typescriptë„ ì„¤ì¹˜ í•´ì•¼í•¨)
  3. codegen.ts íŒŒì¼ ìƒì„± í›„ ì•„ë˜ ì½”ë“œ ë„£ê¸°
    import type { CodegenConfig } from '@graphql-codegen/cli'
 
    const config: CodegenConfig = {
      schema: 'http://main-practice.codebootcamp.co.kr/graphql',  //ğŸˆ api ì—”ë“œí¬ì¸íŠ¸ ì£¼ì†Œ ì…ë ¥í•˜ë©´ íƒ€ì… ë‹¤ìš´
      documents: ['src/**/*.tsx'],                    //ğŸˆ tsë¡œ ì €ì¥í•  ê²ƒì´ê¸°ì— src/**/*.ts ì¶”ê°€
      generates: {
          './src/entities/api': {                            //ğŸˆ ì €ì¥í•  ìœ„ì¹˜
            preset: 'client',
          }
      }
    }
    export default config

  4. í•´ë‹¹ codegen.tsëŠ” ìµœìƒìœ„ ë£¨íŠ¸ì— ìƒì„±í•œë‹¤. (package.json ìœ„ì¹˜)
  5. package.jsonì— ë“¤ì–´ê°€ scriptsì— ì‹¤í–‰ ëª…ë ¹ì–´ ì¶”ê°€(2ë²ˆì— ì„¤ì¹˜ë¡œ ê°€ëŠ¥)
     "codegen": "graphql-codegen --config codegen.ts"
    ì¶”ê°€ í–ˆìœ¼ë©´ yarn codegen ìœ¼ë¡œ ì‹¤í–‰í•´ íƒ€ì… íŒŒì¼ì„ ë°›ì•„ì˜¨ë‹¤.
    ì—ëŸ¬ ìˆìœ¼ë©´ node_modules, yarn.lock ì‚­ì œ í›„ ë‹¤ì‹œ yarn install í›„ yarn codegen
    ì¶”ê°€ ì—ëŸ¬ê°€ ìˆìœ¼ë©´ documents ì£¼ì  ì²˜ë¦¬í•˜ê³  ë‹¤ì‹œ yarn codegení•˜ë©´ ë¨
  6. ê·¸ëŸ¼ í•´ë‹¹ /entities/apiì— íŒŒì¼ ì—¬ëŸ¬ê°œ ìƒì„±ì´ ë˜ëŠ”ë° ì—¬ê¸°ì„œ graphql.tsê°€ ë©”ì¸ì´ë‹¤.
     ì´ì „ documentsë¥¼ í†µí•´ ì„¤ì¹˜ë¥¼ í–ˆìœ¼ë©´ graphql.tsì˜ ë§¨ ì•„ë˜ì— export const CreateBoardDocument ë“± ì—¬ëŸ¬ê°œê°€ ìˆì„ ê²ƒì´ë‹¤.
     ì´ê±´ gql, íƒ€ì… ë“± ì•ˆí•´ë„ ì•Œì•„ì„œ í•´ì¤˜ í¸ì˜ì„±ì€ ì¢‹ìŒ


graphql SSR ìš”ì²­
  useQuery, useMutationì€ CSRì—ì„œë§Œ ë™ì‘ì„ í•œë‹¤.
  ssr ìš”ì²­ì„ í•˜ê¸° ìœ„í•´ì„œëŠ” clientë¥¼ í†µí•´ ìš”ì²­ì„ í•œë‹¤.

  const { data } = await client.query<
    Pick<Query, "fetchBoardsOfTheBest">
  >({
    query: BOARDS_OF_THE_BEST,
    fetchPolicy: "cache-first",
  });

 ì´ë ‡ê²Œ í•´ì„œ ssr ìš”ì²­ì„ í•  ìˆ˜ ìˆìœ¼ë©° clientëŠ” ë‹¤ìŒê³¼ ê°™ì´ ì¶”ê°€í•œë‹¤.

  export const client = new ApolloClient({
    ssrMode: typeof window === "undefined",
    uri: process.env.NEXT_PUBLIC_GRAPHQL_URL, // í™˜ê²½ë³€ìˆ˜ë¡œ GraphQL ì„œë²„ URI ì„¤ì •
    cache: new InMemoryCache(),
  });
  ì—¬ê¸°ì„œ ssrModeë¥¼ ì¶”ê°€í•´ì£¼ë©´ ëœë‹¤.



ì´ë¯¸ì§€ ë¶ˆëŸ¬ì˜¤ê¸° - next.js ì˜ Image íƒœê·¸
next.config.tsì—ì„œ
images: {
  domains: ["storage.googleapis.com"], // ì™¸ë¶€ ì´ë¯¸ì§€ ë„ë©”ì¸ ì¶”ê°€
},
ì™¸ë¶€ ë„ë©”ì¸ì„ ì¶”ê°€í•´ì¤˜ì•¼ ê°€ì ¸ì˜¬ ìˆ˜ ìˆë‹¤.

<Image
  key={el}
  src={`https://storage.googleapis.com/${el}`}
  alt="dd"
  width={30}
  height={30}
  unoptimized // ìµœì í™” ë¹„í™œì„±í™”
/>
ì´ë¯¸ì§€ë¥¼ wedpë¡œ ìµœì í™”ë¡œ ê°€ì ¸ì˜¤ëŠ”ë° ì›ë³¸ ì´ë¯¸ì§€ë¡œ ê°€ì ¸ì˜¤ê¸° ìœ„í•´ì„œëŠ” unoptimized ì‚¬ìš©í•˜ë©´ ëœë‹¤.



ì´ë¯¸ì§€ ì„œë²„ì— ì €ì¥í•˜ê¸°
  ì´ë¯¸ì§€ë¥¼ Storageì— ì €ì¥í•˜ëŠ” API ìš”ì²­ì— ì—ëŸ¬ê°€ ìƒê¸°ëŠ”ë° ë°±ì—”ë“œì„ í†µí•´ ì—”ë“œí¬ì¸íŠ¸ ì„œë²„ë¡œ ê°€ëŠ”ê²Œ
  ì•„ë‹Œ ë‹¤ë¥¸ DB ì¦‰ Storageì— ê°€ëŠ”ê³¼ì •ì— ì˜¤ë¥˜ê°€ ìƒê¸´ê±¸ë¡œ ì¶”ì¸¡..

  ê·¸ë˜ì„œ apollo-upload-clientë¥¼ --devë¡œ ì„¤ì¹˜ë¥¼ í•´ì£¼ê³  ApolloProviderì˜ clientì— ë“¤ì–´ê°€
  createUploadLinkí•¨ìˆ˜ë¥¼ ë¶ˆëŸ¬ì˜¨ë‹¤.

  const GLOBAL_STATE = new InMemoryCache();

  const uploadLink = createUploadLink({
    uri: process.env.NEXT_PUBLIC_GRAPHQL_URL,
  }) as unknown as ApolloLink;

  export const client = new ApolloClient({
    link: ApolloLink.from([uploadLink]),
    cache: GLOBAL_STATE,
  });
  ì´ë ‡ê²Œ í•´ì£¼ë©´ ì •ìƒì ìœ¼ë¡œ ì´ë¯¸ì§€ë¥¼ Storageì— ì €ì¥í•˜ê³  ì´ë¯¸ì§€ ë‹¤ìš´ë°›ì„ ìˆ˜ ìˆëŠ” url ë°˜í™˜í•œë‹¤.






ğŸˆ ë¦¬í˜ì¹˜ ì„±ëŠ¥ ê°œì„ 
1. ëŒ“ê¸€ ë“±ë¡, ìˆ˜ì •, ì‚­ì œ ìš”ì²­ í›„ ëŒ“ê¸€ ëª©ë¡ API ìš”ì²­ì—†ì´ ì—…ë°ì´íŠ¸ í•˜ê¸°
   ReplyInput, Reply ì°¸ê³ 

const onSubmit: SubmitHandler<IFormInput> = async (data) => {
  console.log("Form Data:", data);
  await createBoardCommentInput({
    variables: {
      createBoardCommentInput: {
        writer: data.writer,
        password: data.password,
        rating: value,
        contents: data.contents,
      },
      boardId,
    },
    refetchQueries: ["fetchBoardComments"],
  });
  reset();
  setValue(0);
};

í˜„ì¬ ì´ë ‡ê²Œ ëŒ“ê¸€ì„ ì¶”ê°€í•˜ê³  refetchë¥¼ í†µí•´ ëŒ“ê¸€ ëª©ë¡ì„ ì—…ë°ì´íŠ¸ë¥¼ í•˜ê³  ìˆë‹¤.
ê·¸ëŸ¼ ë“±ë¡ API / ë¦¬í˜ì¹˜ APIë¡œ 2ë²ˆì˜ API ìš”ì²­ì´ ì¼ì–´ë‚˜ëŠ”ë°
ë¦¬í˜ì¹˜ APIë¥¼ ë³´ë‚´ì§€ ì•Šê³  ApolloCacheë¥¼ ìˆ˜ì •í•´ ì—…ë°ì´íŠ¸ í•˜ëŠ” ë°©ë²•ìœ¼ë¡œ ì—…ë°ì´íŠ¸ë¥¼ í•  ê²ƒì´ë‹¤.

refetchQueries: ["fetchBoardComments"]ë¥¼ ì§€ìš°ê³  ê·¸ ìë¦¬ì— update()ë¥¼ ì‚¬ìš©í•œë‹¤.

update(cache, {data}) {
  cache.modify({
    fields: {
      fetchBoardComments: (prev) => {
        return [data.createBoardComment, ...prev]
      }
    }
  })
}
ì´ë ‡ê²Œ í•´ì£¼ë©´ ë“±ë¡ APIë§Œ ìš”ì²­ìœ¼ë¡œ ëŒ“ê¸€ ëª©ë¡ë„ ì—…ë°ì´íŠ¸ í•  ìˆ˜ ìˆë‹¤.
ì—¬ê¸°ì„œ dataëŠ” createBoardCommentInputì˜ ë°ì´í„° ê°’ì´ë‹¤.

ì‚­ì œ ê°™ì€ ê²½ìš° ì¶”ê°€ë˜ëŠ” ì ì´ ìˆë‹¤.
update(cache, {data}) {
  cache.modify({
    fields: {
      fetchBoardComments: (prev, { readField }) => {
        const deletedId = data.deleteBoardComment
        const filteredPrev = prev.filter(
          (el) => readField("_id", el) !== deletedId
        );
        return [...filteredPrev]
      }
    }
  })
}
readFieldë¥¼ ì¶”ê°€ë¥¼ í–ˆëŠ”ë° ê·¸ëƒ¥ elì´ ì•„ë‹Œ _idë¡œ ëª…í™•í•˜ê²Œ ì§€ì •ì„ í•´ì¤˜ì•¼í•œë‹¤.
ì´ìœ ê°€ prevë¥¼ ì¶œë ¥ì„ í•´ë³´ë©´ refë¡œ id ê°’ì´ ìˆì–´ elë¡œ idê°’ì„ ê°€ì ¸ì˜¬ ìˆ˜ ì—†ë‹¤.
ê·¸ë˜ì„œ readFieldë¥¼ í†µí•´ refì— ë“¤ì–´ê°€ _idë¥¼ ê°€ì ¸ì™€ì•¼ í•œë‹¤.
(el._id ê°€ ì•„ë‹Œ ì´ìœ ëŠ” deleteì— ë°˜í™˜ ê°’ì´ _idë§Œ ìˆì–´ êµ³ì´ ì‚¬ìš©í•  í•„ìš”ì—†ë‹¤.)

í•˜ì§€ë§Œ updateBoardCommentëŠ” refetchQueries, update() ì—†ì´ë„ ëŒ“ê¸€ ëª©ë¡ì´ ì—…ë°ì´íŠ¸ê°€ ëœë‹¤.
ì •í™•í•œ ì´ìœ ëŠ” ëª¨ë¥´ê² ì§€ë§Œ ê°™ì€ BoardComment íƒ€ì…ì˜ idë¥¼ ì‚¬ìš©í•˜ê³  ìˆì–´ ìºì‹±ì— ìë™ìœ¼ë¡œ
ì—…ë°ì´íŠ¸ê°€ ë˜ì§€ ì•Šë‚˜ ì‹¶ìŒ.


cache.modify / cache.writeQuery ì˜ ì°¨ì´
modify: ìˆëŠ” ë°ì´í„°ë¥¼ ìˆ˜ì • í•  ìˆ˜ ìˆë‹¤.
writeQuery: ì—†ëŠ” ë°ì´í„°ë¥¼ ì¶”ê°€, ìˆ˜ì • í•  ìˆ˜ ìˆë‹¤.


ğŸˆ ì˜µí‹°ë¯¸ìŠ¤í‹±UI: ì„±ê³µì„ ì˜ˆìƒí•˜ê³  í™”ë©´ì— ë¯¸ë¦¬ ì—…ë°ì´íŠ¸ í•˜ê¸°
